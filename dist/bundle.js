const e=new(window.AudioContext||window.webkitAudioContext);let t=!1,n=!0,o=.4,r=!1,i=[],l=0;const a=250,c=.22,s=document.getElementById("audio-toggle");function m(){t||e.resume().then(()=>{t=!0})}function f(){if(!t||!n)return;const o=e.createOscillator(),r=e.createGain();o.type="sine",o.connect(r),r.connect(e.destination),r.gain.setValueAtTime(.4,e.currentTime),r.gain.exponentialRampToValueAtTime(.001,e.currentTime+.7),o.frequency.setValueAtTime(400,e.currentTime),o.frequency.exponentialRampToValueAtTime(700,e.currentTime+.35),o.frequency.exponentialRampToValueAtTime(450,e.currentTime+.7),o.start(),o.stop(e.currentTime+.7)}function y(o=440,r=.05,i="square"){if(!t||!n)return;const l=e.createOscillator(),a=e.createGain();l.type=i,l.frequency.value=o,l.connect(a),a.connect(e.destination),a.gain.setValueAtTime(.1,e.currentTime),a.gain.exponentialRampToValueAtTime(.001,e.currentTime+r),l.start(),l.stop(e.currentTime+r)}function u(){if(!t||!n)return;const o=performance.now();if(o-l<a)return;l=o;const r=e.createOscillator(),i=e.createGain();r.type="sine",r.frequency.value=300+50*Math.random(),r.connect(i),i.connect(e.destination),i.gain.setValueAtTime(c,e.currentTime),i.gain.exponentialRampToValueAtTime(.001,e.currentTime+.08),r.start(e.currentTime),r.stop(e.currentTime+.08)}s.addEventListener("click",()=>{n=!n,s.textContent=n?"ðŸ”Š":"ðŸ”‡",n&&m()});const d=[{freq:523},{freq:493},{freq:523},{freq:493},{freq:523},{freq:493},{freq:392},{freq:415}];function h(t,n,o){const r=e.createOscillator(),i=e.createGain();r.type="square",r.frequency.value=t,r.connect(i),i.connect(e.destination),i.gain.setValueAtTime(.2,o),i.gain.exponentialRampToValueAtTime(.001,o+n),r.start(o),r.stop(o+n)}function x(l,a=o,c=!0){if(!t||!n)return;p(),r=!0,o=a;let s=e.currentTime;if(l.forEach(t=>{if(!r)return;const n=e.createOscillator(),o=e.createGain();n.type="triangle",n.frequency.value=t.freq,n.connect(o),o.connect(e.destination),o.gain.setValueAtTime(.2,s),o.gain.exponentialRampToValueAtTime(.001,s+a),n.start(s),n.stop(s+a),i.push(n),s+=1.1*a}),c){const e=l.reduce(e=>e+1.1*a,0);setTimeout(()=>{r&&x(l,o,c)},1e3*e)}}function p(){r=!1,i.forEach(e=>{try{e.stop()}catch(e){}}),i=[]}window.addEventListener("keydown",m,{once:!0}),window.addEventListener("mousedown",m,{once:!0});const g=[[1,0,0,1,1,0,0,0],[1,0,1,1,1,1,0,0],[1,1,1,1,1,0,1,0],[1,1,1,1,1,0,1,1],[1,1,1,1,1,1,1,0],[1,0,1,1,1,1,0,0],[1,0,0,1,1,0,0,0]],T=[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,2,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1],[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],[0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0],[0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0],[0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,1,0,1,1,0,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,0,0,0,1,0,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,0,0,1,1,0,0,0],[0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0]],w=[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,2,1,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[1,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[0,1,1,1,1,1,0,0,1,1,1,1,1,1,1,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,1,1,1,0,1,1,1,0,0,0,0],[0,0,0,0,0,0,1,1,1,0,0,1,1,1,0,0,0,0,0,1,1,0,0,0,1,1,1,0,0,0],[0,0,0,0,0,0,1,1,1,0,0,1,1,1,0,0,0,0,0,1,1,0,0,0,0,1,1,1,0,0],[0,0,0,0,0,0,1,1,0,0,0,0,1,1,1,0,0,0,0,1,1,1,0,0,0,0,1,1,0,0],[0,0,0,0,0,0,1,1,1,0,0,0,0,1,1,1,0,0,0,0,1,1,1,0,0,0,1,1,1,0]],v=[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,2,1,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[1,1,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[0,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[0,0,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,1,1,1,0,1,1,1,0,0,0,0],[0,0,0,0,0,0,1,1,1,0,0,1,1,1,0,0,0,0,0,1,1,0,0,0,1,1,1,0,0,0],[0,0,0,0,0,0,1,1,1,0,0,1,1,1,0,0,0,0,0,1,1,0,0,0,0,1,1,1,0,0],[0,0,0,0,0,0,1,1,0,0,0,0,1,1,1,0,0,0,0,1,1,1,0,0,0,0,1,1,0,0],[0,0,0,0,0,0,1,1,1,0,0,0,0,1,1,1,0,0,0,0,1,1,1,0,0,0,1,1,1,0]],M=[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,3,3,3,3,3,3,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,11,11,11,11,11,11,11,4,4,4,4,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,3,11,11,11,11,11,11,11,11,4,4,4,7,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,3,11,11,11,11,11,11,11,4,4,7,7,7,7,4,4,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,3,11,11,11,11,11,11,11,11,4,4,7,7,7,7,4,4,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,3,11,11,11,11,11,11,11,11,4,7,7,7,2,2,2,4,4,0,0,0,0],[0,0,0,0,0,0,0,0,0,3,3,11,11,11,11,11,11,4,4,7,7,7,2,2,2,2,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,3,3,3,3,11,11,11,11,4,4,7,7,7,2,2,2,2,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,3,3,3,11,4,4,4,12,2,2,2,1,1,2,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,4,12,12,12,2,2,2,6,6,2,2,2,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,4,12,12,12,2,2,2,12,12,2,2,2,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,8,8,8,8,4,13,13,13,2,2,2,2,2,2,2,2,2,2,0,0,0],[0,0,0,0,0,0,0,0,0,8,8,8,8,8,8,8,4,13,13,2,2,2,2,12,12,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,8,8,8,8,8,8,8,4,13,13,2,2,2,2,5,5,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,8,8,8,8,8,8,8,8,8,8,4,4,2,2,2,2,2,2,2,0,0,0,0,0,0],[0,0,0,0,0,0,8,8,8,8,8,8,4,4,8,8,8,8,4,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,8,8,8,8,8,8,4,4,8,8,8,8,8,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,8,8,8,8,8,4,4,4,8,8,4,8,8,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,8,8,8,8,8,4,4,4,8,8,4,8,8,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,4,4,8,8,8,8,8,4,8,8,8,8,8,4,4,4,4,4,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,4,4,8,8,8,8,8,4,8,8,8,8,8,8,8,4,4,4,4,0,0,0,0,0,0,0,0,0],[0,0,0,0,4,4,8,8,8,8,8,4,8,8,8,8,8,8,8,4,4,4,4,0,0,0,0,0,0,0,0,0],[0,0,0,0,4,4,4,8,8,8,8,8,4,4,8,8,8,8,8,8,4,4,4,0,0,0,0,0,0,0,0,0],[0,0,0,0,4,4,4,8,8,8,8,8,4,4,8,8,8,8,8,8,4,4,4,0,0,0,0,0,0,0,0,0],[0,0,0,0,4,4,4,4,4,2,2,2,4,4,4,4,4,8,8,8,2,2,2,0,0,0,0,0,0,0,0,0],[9,9,9,9,9,9,9,9,10,2,2,2,2,2,9,9,9,9,9,10,2,2,2,9,9,9,9,9,9,9,9,0],[9,9,9,9,9,9,9,9,10,2,2,2,2,2,9,9,9,9,9,10,2,2,2,9,9,9,9,9,9,9,9,0],[0,0,0,0,4,4,4,4,4,4,4,2,2,2,4,4,4,4,4,4,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,4,4,4,4,4,4,4,8,8,8,8,8,8,8,8,8,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,4,4,4,4,4,4,4,8,8,8,8,8,8,8,8,8,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,4,4,4,4,4,4,4,8,8,8,8,8,8,8,8,8,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,10,9,9,9,0,0,0,0,10,9,9,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,10,9,9,9,0,0,0,0,10,9,9,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,10,9,9,0,0,0,0,0,10,9,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,10,10,10,10,10,0,0,0,10,10,10,10,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,10,10,10,10,10,0,0,0,10,10,10,10,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],E=[T,w,v];let b=400,k=300,A=0,S=0,q=!1,z=null,L=0,R=0,V=0,X=!1,Y=1,W=0;const B=3,I=.45,N=5,G=5,O=15,C=document.getElementById("stage"),F=document.getElementById("game"),$=F.getContext("2d");let U={x:100,y:75,speed:4},D={roomX:0,roomY:0,x:0,y:0,size:14,vx:0,vy:0,wanderTimer:0,wanderSpeed:.5,chaseSpeed:1.4,sight:140};function H(e,t){return Array.from({length:e},()=>Array.from({length:t},()=>({N:!0,S:!0,E:!0,W:!0})))}function P(){z=H(5,5);for(let e=0;e<5;e++)for(let t=0;t<5;t++)e+1<5&&Math.random()<I&&(z[e][t].E=!1,z[e+1][t].W=!1),t+1<5&&Math.random()<I&&(z[e][t].S=!1,z[e][t+1].N=!1);K()}function j(e,t){const n=[];return t>0&&z[e][t].N&&n.push({x:e,y:t-1}),t+1<5&&z[e][t].S&&n.push({x:e,y:t+1}),e+1<5&&z[e][t].E&&n.push({x:e+1,y:t}),e>0&&z[e][t].W&&n.push({x:e-1,y:t}),n}function J(e=0,t=0){const n=Array.from({length:5},()=>Array(5).fill(!1)),o=[{x:e,y:t}];for(n[e][t]=!0;o.length;){const{x:e,y:t}=o.shift();for(const r of j(e,t))n[r.x][r.y]||(n[r.x][r.y]=!0,o.push(r))}return n}function K(){for(;;){const e=J(0,0);let t=!0;for(let n=0;n<5;n++){for(let o=0;o<5;o++)if(!e[n][o]){t=!1;break}if(!t)break}if(t)return;let n=!1;for(let t=0;t<5&&!n;t++)for(let o=0;o<5&&!n;o++)if(e[t][o]){if(t+1<5&&!z[t][o].E&&!e[t+1][o]){z[t][o].E=!0,z[t+1][o].W=!0,n=!0;break}if(o+1<5&&!z[t][o].S&&!e[t][o+1]){z[t][o].S=!0,z[t][o+1].N=!0,n=!0;break}if(t>0&&!z[t][o].W&&!e[t-1][o]){z[t][o].W=!0,z[t-1][o].E=!0,n=!0;break}if(o>0&&!z[t][o].N&&!e[t][o-1]){z[t][o].N=!0,z[t][o-1].S=!0,n=!0;break}}if(!n)return}}const Q=3*E[0][0].length,Z=3*E[0].length,_=3*g[0].length,ee=3*g.length;function te(e,t,n,{scale:o=3,flip:r=!1,colors:i={}}={}){for(let l=0;l<n.length;l++)for(let a=0;a<n[l].length;a++){const c=n[l][r?n[l].length-1-a:a];0!==c&&i[c]&&($.fillStyle=i[c],$.fillRect(e+a*o,t+l*o,o,o))}}function ne(e,t,n,o=!1){te(e,t,n,{scale:3,flip:o,colors:{1:"#000",2:"#FF0000"}})}function oe(){se.collected||A===se.roomX&&S===se.roomY&&te(se.x,se.y,g,{scale:3,colors:{1:"#4cf"}})}function re(e,t,n,{scale:o=3,flip:r=!1}={}){const i={1:"rgb(0,0,0)",2:"rgb(226,164,122)",3:"rgb(101,45,45)",4:"rgb(37,26,40)",5:"rgb(251,242,54)",6:"rgb(255,255,255)",7:"rgb(120,114,102)",8:"rgb(51,37,59)",9:"rgb(75,42,30)",10:"rgb(52,29,22)",11:"rgb(147,65,60)",12:"rgb(208,138,96)",13:"rgb(68,64,63)"};for(let l=0;l<n.length;l++)for(let a=0;a<n[l].length;a++){const c=n[l][r?n[l].length-1-a:a];0!==c&&($.fillStyle=i[c],$.fillRect(e+a*o,t+l*o,o,o))}}function ie(){fe.forEach(e=>{A===e.roomX&&S===e.roomY&&re(e.x,e.y,M,{scale:2,flip:!1})})}function le(){const e=z[A][S];$.lineWidth=8,$.strokeStyle="rgba(255, 0, 0, 0.6)",$.beginPath(),e.N||($.moveTo(0,0),$.lineTo(b,0)),e.S||($.moveTo(0,k),$.lineTo(b,k)),e.W||($.moveTo(0,0),$.lineTo(0,k)),e.E||($.moveTo(b,0),$.lineTo(b,k)),$.stroke()}function ae(){xe&&A===xe.x&&S===xe.y&&($.strokeStyle="yellow",$.lineWidth=6,$.strokeRect(0,0,b,k))}function ce(){$.clearRect(0,0,b,k);const e=40*(A+5*S);$.fillStyle=`hsl(${e},50%,20%)`,$.fillRect(0,0,b,k),$.fillStyle="#ddd",$.font="12px monospace",$.fillText(`Fish: ${se.collected?"âœ“":"âœ—"} â€¢ Level: ${Y}`,10,16),oe(),ie(),ae(),le(),ne(U.x,U.y,E[L],X),V>0&&(V--,$.fillStyle="rgba(255,0,0,0.25)",$.fillRect(0,0,b,k)),W>0&&(W--,$.fillStyle="yellow",$.font="24px monospace",$.fillText("GET OUT!",b/2-50,k/2))}const se={};function me(){se.collected=!1,se.roomX=Math.floor(5*Math.random()),se.roomY=Math.floor(5*Math.random()),0===se.roomX&&0===se.roomY&&(se.roomX<4?se.roomX++:se.roomY++),se.x=Math.floor((b-_)/2),se.y=Math.floor((k-ee)/2)}me();const fe=[];function ye(){const e={...D};do{e.roomX=Math.floor(5*Math.random()),e.roomY=Math.floor(5*Math.random())}while(0===e.roomX&&0===e.roomY);return e.x=Math.random()*(b-e.size),e.y=Math.random()*(k-e.size),e}fe.push(ye());const ue={};function de(){b=Math.floor(window.innerWidth/5),k=Math.floor(window.innerHeight/5),F.width=b,F.height=k;const e=b-Q,t=k-Z;U.x<0&&(U.x=0),U.y<0&&(U.y=0),U.x>e&&(U.x=e),U.y>t&&(U.y=t),fe.forEach(e=>{e.x=Math.max(0,Math.min(b-e.size,e.x)),e.y=Math.max(0,Math.min(k-e.size,e.y))}),se.x=Math.max(0,Math.min(b-_,se.x)),se.y=Math.max(0,Math.min(k-ee,se.y)),he()}function he(){C.style.left=A*b+"px",C.style.top=S*k+"px"}addEventListener("keydown",e=>ue[e.key]=!0),addEventListener("keyup",e=>ue[e.key]=!1),window.addEventListener("resize",de);let xe=null;function pe(){const e=[];for(let t=0;t<5;t++)for(let n=0;n<5;n++)0!==t&&4!==t&&0!==n&&4!==n||t===se.roomX&&n===se.roomY||e.push({x:t,y:n});xe=e[Math.random()*e.length|0]}function ge(e){if(A!==e.roomX||S!==e.roomY)return;const t=U.x+.5*Q,n=U.y+.5*Z,o=t-(e.x+.5*e.size),r=n-(e.y+.5*e.size),i=Math.hypot(o,r);if(i<e.sight){const t=e.chaseSpeed/(i||1);e.vx=o*t,e.vy=r*t}else if(e.wanderTimer<=0){const t=[-1,0,1];e.vx=t[3*Math.random()|0]*e.wanderSpeed,e.vy=t[3*Math.random()|0]*e.wanderSpeed,e.wanderTimer=60+(60*Math.random()|0)}else e.wanderTimer--;e.x+=e.vx,e.y+=e.vy,e.x<0&&(e.x=0,e.vx*=-.5),e.y<0&&(e.y=0,e.vy*=-.5),e.x>b-e.size&&(e.x=b-e.size,e.vx*=-.5),e.y>k-e.size&&(e.y=k-e.size,e.vy*=-.5)}function Te(){return fe.some(e=>{if(A!==e.roomX||S!==e.roomY)return!1;const t=U.x,n=U.y,o=Q,r=Z,i=e.x,l=e.y,a=e.size,c=e.size;return!(i>t+o||i+a<t||l>n+r||l+c<n)})}function we(){let e=!1;ue.ArrowUp&&(U.y-=U.speed,e=!0),ue.ArrowDown&&(U.y+=U.speed,e=!0),ue.ArrowLeft&&(U.x-=U.speed,e=!0,X=!0),ue.ArrowRight&&(U.x+=U.speed,e=!0,X=!1);let t=!1;if(U.x<0&&(A>0&&z[A][S].W?(A--,U.x+=b,t=!0):U.x=0),U.x+Q>b&&(A<4&&z[A][S].E?(A++,U.x-=b,t=!0):U.x=b-Q),U.y<0&&(S>0&&z[A][S].N?(S--,U.y+=k,t=!0):U.y=0),U.y+Z>k&&(S<4&&z[A][S].S?(S++,U.y-=k,t=!0):U.y=k-Z),t&&he(),e?(R++,R>O&&(R=0,L=1===L?2:1),u()):L=0,fe.forEach(ge),Te()&&(V=18,y(900,.08,"square"),ze("You were caught!",!1,!0),p(),Ae.disabled=!1,q=!0,U.x=Math.max(0,Math.min(b-Q,.5*(b-Q))),U.y=Math.max(0,Math.min(k-Z,.5*(k-Z)))),!se.collected&&A===se.roomX&&S===se.roomY){const e={x:U.x,y:U.y,w:Q,h:Z},t={x:se.x,y:se.y,w:_,h:ee};!(t.x>e.x+e.w||t.x+t.w<e.x||t.y>e.y+e.h||t.y+t.h<e.y)&&(se.collected=!0,x(d,.2),f(),pe(),W=60)}Me()&&(ze("Next level!",!0,!1),Se.disabled=!1,p())}function ve({sameLevel:e=!1}={}){A=0,S=0,U.x=Math.floor((b-Q)/2),U.y=Math.floor((k-Z)/2),he(),me(),xe=null,e?(Y=1,fe.length=0,fe.push(ye())):(Y++,fe.push(ye())),P(),document.getElementById("next-level").disabled=!0,document.getElementById("modal").style.display="none"}function Me(){return!(!xe||!se.collected)&&A===xe.x&&S===xe.y&&(0===xe.x&&U.x<=0||4===xe.x&&U.x+Q>=b||0===xe.y&&U.y<=0||4===xe.y&&U.y+Z>=k)}function Ee(){q||we(),ce(),requestAnimationFrame(Ee)}function be(){de(),he(),P(),Ee()}be();const ke=document.getElementById("modal"),Ae=document.getElementById("restart"),Se=document.getElementById("next-level"),qe=document.getElementById("mtext");function ze(e="Game Over",t=!1,n=!0){qe.textContent=e,Se.style.display=t?"inline-block":"none",Ae.style.display=n?"inline-block":"none",ke.style.display="flex"}Ae.addEventListener("click",()=>{ke.style.display="none",ve({sameLevel:!0}),q=!1}),Se.addEventListener("click",()=>{ke.style.display="none",ve({sameLevel:!1})}),document.addEventListener("keydown",e=>{"Enter"===e.key&&("none"!==Se.style.display?Se.click():"none"!==Ae.style.display&&Ae.click(),ke.style.display="none")});